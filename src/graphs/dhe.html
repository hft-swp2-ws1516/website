<script type="text/javascript" src="js/helperClass.js"></script>

<div id='error-message'></div>
<div id="dheChart"></div>

<script>

var totalHosts;

jQuery.get("http://hotcat.de:1337/api/v0/pfs/overview", function (response) {
  totalHosts = response;
}).error(function () {
  $('#error-message').html('<div class="alert alert-danger" role="alert">Error loading JSON!</div>');
  $("#loader").css("display","none");
}).done(function() {

 // Load data from the server using a HTTP GET request
 // jquery.get is a equivalent to $.ajax({....
  jQuery.get("http://hotcat.de:1337/api/v0/pfs/distribution", function (response) {
   var start = getTimespan();

   if (start[0] != start[1]) {

               // filter response Array by timespan
               filtered = filterResponseByTimespan(response, new Date(parseInt(start[0])), new Date(parseInt(start[1])));

               var months = [];
               for (var i = 0; i < filtered.length; i++) {
                months.push(filtered[i].month);
              }
              ;

               // filter hostcount endpoint by given timespan
               filteredTotalHosts = filterResponseByTimespan(totalHosts, new Date(parseInt(start[0])), new Date(parseInt(start[1])));


              // percentual line
              for (var i = 0; i < filtered.length; i++) {
                var distribution = filtered[i].distribution;
                filtered[i].totalHosts = filteredTotalHosts[i].monthlyPfsEnabled;
                for (var j = distribution.length - 1; j >= 0; j--) {
                  distribution[j].percent = ((distribution[j].count / filteredTotalHosts[i].monthlyPfsEnabled) * 100).toFixed(2);

                };
              };

              // Convert the response in syntax like : { '512': [323,3234], '1024': [421,3424]}
              var json = {};
              // iterate over all months
              for (var i = 0; i < filtered.length; i++) {
                // get distribution array
                var distribution = filtered[i].distribution;
                // this array is for table, graph differs from the table
                var tempArray = [];
                // iterate over the distribution of one month
                for (var j = 0; j < distribution.length; j++) {
                  // only take dh keygorups
                  if (distribution[j].kx == "DH") {
                    tempArray.push(distribution[j]);
                    // fields with the value 0 should not be drawn
                    if ( distribution[j].percent != 0) {
                      if (!(Array.isArray(json[distribution[j].kxStrength]))) {
                        json[distribution[j].kxStrength] = [];
                      };  
                  // if there is ja new key and the previous elements in the array are null, then c3 will not work
                  if (i >= 1 && !json[distribution[j].kxStrength][i-1]) {
                    json[distribution[j].kxStrength][i-1]=0;
                  };
                  json[distribution[j].kxStrength][i] = distribution[j].percent;
                };


              };

            };
            filtered[i].distribution = tempArray;

          };


              // draw Table and say which keys should be printed,
              drawTable(["month","distribution", "totalHosts"], filtered, ["kxStrength", "count", "percent"] );

              chart = c3.generate({
                bindto: '#dheChart',
                data: {
                  json: json,
                },
                axis: {
                  x: {
                    type: 'category',
                    categories: months,
                  },
                  y: {
                    label: {
                      text: 'In Percent',
                      position: 'outer-middle'
                    },
                    min: 0,
                    max: 99,
                  }
                },

              }); 


            }
            else{
             var filtered = filterResponseByTimespan(response, new Date(parseInt(start[0])), new Date(parseInt(start[1])));
               // filter hostcount endpoint by given timespan
               filteredTotalHosts = filterResponseByTimespan(totalHosts, new Date(parseInt(start[0])), new Date(parseInt(start[1])));


               // remove ECDHE data
               var filteredElement = filtered[0].distribution;

               for (var i = filteredElement.length - 1; i >= 0; i--) {
                filteredElement[i].totalHosts =  filteredTotalHosts[0].monthlyPfsEnabled;
                if (filteredElement[i].kx == "ECDH") {
                  filteredElement.splice(i, 1);
                };

              }

              chart = c3.generate({
                bindto: '#dheChart',
                data: {
                  json: filteredElement,
                  keys: {
                    x: 'kxStrength',
                    value: ['count']
                  },
                  type: 'bar',
                },
                axis: {
                  x: {
                    type: 'category',
                  },
                  y: {
                    label: {
                      text: 'Total Count',
                      position: 'outer-middle'
                    },
                  }
                },
              });
              drawTable(["kxStrength","count", "totalHosts"], filteredElement);
            }
          }).error(function () {
            $('#error-message').html('<div class="alert alert-danger" role="alert">Error loading JSON!</div>');
            $("#loader").css("display","none");
          }).done(function() {
           $("#loader").css("display","none");
         });



        });


</script>